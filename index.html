<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾ç‰™å¹¸é‹å¤§æŠ½ç</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #fce4ec; color: #333; text-align: center; margin: 0; padding: 20px; }
        h1 { color: #d32f2f; margin-bottom: 10px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* æ§åˆ¶å€ */
        .controls { margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; border: 1px solid #ffe0b2; }
        button { cursor: pointer; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; margin: 5px; transition: 0.3s; }
        .btn-draw { background-color: #d32f2f; color: white; font-weight: bold; font-size: 20px; }
        .btn-draw:hover { background-color: #b71c1c; transform: scale(1.05); }
        .btn-reset { background-color: #607d8b; color: white; }
        .btn-init { background-color: #ff9800; color: white; }
        
        /* é¡¯ç¤ºå€ */
        #current-winner { font-size: 24px; color: #d32f2f; font-weight: bold; margin: 20px 0; min-height: 40px; animation: pop 0.5s ease; }
        
        /* åˆ—è¡¨å€ */
        .list-container { display: flex; gap: 20px; text-align: left; }
        .column { flex: 1; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee; max-height: 400px; overflow-y: auto; }
        .column h3 { border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-top: 0; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .delete-btn { color: red; cursor: pointer; font-size: 12px; border: 1px solid red; padding: 2px 5px; border-radius: 3px; }
        .delete-btn:hover { background: red; color: white; }

        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‰ å¹´çµ‚å°¾ç‰™å¤§æŠ½ç ğŸ‰</h1>
    
    <div class="controls">
        <p>è³‡æ–™åº«ç‹€æ…‹ï¼š<span id="status">é€£ç·šä¸­...</span></p>
        <button class="btn-init" id="btn-init">1. åˆå§‹åŒ–è³‡æ–™ (é‡è¨­å“¡å·¥èˆ‡çå“)</button>
        <button class="btn-draw" id="btn-draw">2. ğŸ ç«‹å³æŠ½ç</button>
        <button class="btn-reset" id="btn-clear">3. æ¸…ç©ºå¾—çåå–®</button>
    </div>

    <div id="current-winner">æº–å‚™é–‹å§‹...</div>

    <div class="list-container">
        <div class="column">
            <h3>ğŸ† å¾—çåå–® (<span id="winner-count">0</span>)</h3>
            <div id="winner-list">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="column">
            <h3>ğŸ å‰©é¤˜çå“ (<span id="prize-count">0</span>)</h3>
            <div id="prize-list">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<script type="module">
  // 1. å¼•å…¥å¿…è¦çš„ Firebase å‡½å¼åº«
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 2. ä½ çš„ Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyBoL3DxXJRhM6GOtXr6Zws9JWM4XJcHJpc",
    authDomain: "hw8-f71c9.firebaseapp.com",
    projectId: "hw8-f71c9",
    storageBucket: "hw8-f71c9.firebasestorage.app",
    messagingSenderId: "949628146758",
    appId: "1:949628146758:web:42b8fbb0c006c4f039a647",
    measurementId: "G-LL2LQS68JN"
  };

  // 3. åˆå§‹åŒ– Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const statusSpan = document.getElementById('status');
  statusSpan.innerText = "å·²é€£ç·šè‡³ Firebase";
  statusSpan.style.color = "green";

  // è³‡æ–™åº«é›†åˆåç¨±
  const COLL_PRIZES = "prizes";
  const COLL_EMPLOYEES = "employees";
  const COLL_WINNERS = "winners";

  // --- åŠŸèƒ½ 1: åˆå§‹åŒ–è³‡æ–™ (Create) ---
  // ç”¢ç”Ÿ 120 ä½å“¡å·¥å’Œ 100 å€‹çå“
  document.getElementById('btn-init').addEventListener('click', async () => {
      if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™æœƒåˆªé™¤ç›®å‰çš„ç´€éŒ„ä¸¦é‡æ–°ç”¢ç”Ÿå‡è³‡æ–™ã€‚")) return;
      
      const batch = writeBatch(db);
      statusSpan.innerText = "æ­£åœ¨åˆå§‹åŒ–è³‡æ–™...";

      // æ¸…ç©ºèˆŠè³‡æ–™ (ç°¡å–®å¯¦ä½œï¼šå¯¦éš›å°ˆæ¡ˆæ‡‰åˆ†æ‰¹åˆªé™¤ï¼Œé€™è£¡å‡è¨­è³‡æ–™é‡å°‘)
      const list = [COLL_PRIZES, COLL_EMPLOYEES, COLL_WINNERS];
      for(const colName of list) {
          const snapshot = await getDocs(collection(db, colName));
          snapshot.forEach(doc => batch.delete(doc.ref));
      }

      // 1. å»ºç«‹ 120 ä½å“¡å·¥
      for (let i = 1; i <= 120; i++) {
          const empRef = doc(collection(db, COLL_EMPLOYEES));
          batch.set(empRef, { name: `å“¡å·¥ ${i.toString().padStart(3, '0')} è™Ÿ`, taken: false });
      }

      // 2. å»ºç«‹ 100 å€‹çå“ (å‡å®šçµæ§‹)
      // ç‰¹ç 1å€‹, é ­ç 3å€‹, äºŒç 6å€‹, æ™®ç 90å€‹
      const prizes = [
          { name: "ğŸš€ ç‰¹ç: æ­æ´²ä¾†å›æ©Ÿç¥¨", count: 1 },
          { name: "ğŸ’ é ­ç: iPhone 15 Pro", count: 3 },
          { name: "ğŸ’° äºŒç: ç¾é‡‘ $10,000", count: 6 },
          { name: "ğŸ æ™®ç: ç™¾è²¨ç¦®åˆ¸ $1,000", count: 90 }
      ];

      prizes.forEach(p => {
          for(let j=0; j<p.count; j++) {
             const prizeRef = doc(collection(db, COLL_PRIZES));
             batch.set(prizeRef, { name: p.name, taken: false, order: j }); // orderç”¨æ–¼æ’åº
          }
      });

      await batch.commit();
      statusSpan.innerText = "è³‡æ–™åˆå§‹åŒ–å®Œæˆï¼";
      alert("è³‡æ–™å·²é‡ç½®ï¼");
  });

  // --- åŠŸèƒ½ 2: æŠ½çé‚è¼¯ (Update & Create) ---
  document.getElementById('btn-draw').addEventListener('click', async () => {
      // 1. æ’ˆå–æœªæŠ½å‡ºçš„çå“
      const prizeQ = query(collection(db, COLL_PRIZES));
      const prizeSnap = await getDocs(prizeQ);
      const availablePrizes = prizeSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(p => !p.taken);

      if (availablePrizes.length === 0) {
          alert("æ‰€æœ‰çå“éƒ½æŠ½å®Œäº†ï¼");
          return;
      }

      // 2. æ’ˆå–æœªä¸­ççš„å“¡å·¥
      const empQ = query(collection(db, COLL_EMPLOYEES));
      const empSnap = await getDocs(empQ);
      const availableEmps = empSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(e => !e.taken);

      if (availableEmps.length === 0) {
          alert("æ‰€æœ‰å“¡å·¥éƒ½ä¸­çäº†ï¼(æˆ–è€…äººæ•¸ä¸è¶³)");
          return;
      }

      // 3. éš¨æ©ŸæŠ½é¸
      const randomEmpIndex = Math.floor(Math.random() * availableEmps.length);
      const winnerEmp = availableEmps[randomEmpIndex];
      
      // çå“é †åºï¼šé€™è£¡ç°¡å–®é‚è¼¯ï¼ŒæŒ‰é †åºæŠ½ï¼Œæˆ–è€…éš¨æ©ŸæŠ½ã€‚æˆ‘å€‘å–ç¬¬ä¸€å€‹å¯ç”¨çš„çå“(é€šå¸¸æ˜¯å¤§çåœ¨å…ˆæˆ–å¾Œçœ‹è¼¸å…¥é †åº)
      // ç‚ºäº†åˆºæ¿€ï¼Œæˆ‘å€‘é€™è£¡éš¨æ©ŸæŠ½ä¸€å€‹çå“å‡ºä¾†
      const randomPrizeIndex = Math.floor(Math.random() * availablePrizes.length);
      const prizeWon = availablePrizes[randomPrizeIndex];

      // 4. å¯«å…¥è³‡æ–™åº« (ä½¿ç”¨ Batch ç¢ºä¿ä¸€è‡´æ€§)
      const batch = writeBatch(db);

      // æ¨™è¨˜å“¡å·¥å·²ä¸­ç
      const empRef = doc(db, COLL_EMPLOYEES, winnerEmp.id);
      batch.update(empRef, { taken: true });

      // æ¨™è¨˜çå“å·²æŠ½å‡º
      const prizeRef = doc(db, COLL_PRIZES, prizeWon.id);
      batch.update(prizeRef, { taken: true });

      // æ–°å¢åˆ°å¾—çåå–®
      const winnerRef = doc(collection(db, COLL_WINNERS));
      batch.set(winnerRef, { 
          empName: winnerEmp.name, 
          prizeName: prizeWon.name,
          timestamp: new Date()
      });

      await batch.commit();

      // UI å‹•ç•«
      const display = document.getElementById('current-winner');
      display.innerHTML = `æ­å–œ <span style="color:#d32f2f;font-size:30px">${winnerEmp.name}</span><br>ç²å¾— <span style="background:#ffd54f;padding:0 5px">${prizeWon.name}</span>`;
  });

  // --- åŠŸèƒ½ 3: æ¸…ç©ºå¾—çåå–® (Delete All - for reset) ---
  document.getElementById('btn-clear').addEventListener('click', async () => {
      if(!confirm("ç¢ºå®šè¦æ¸…ç©ºå¾—çç´€éŒ„ï¼Ÿ(å“¡å·¥å°‡æ¢å¾©æœªä¸­çç‹€æ…‹ï¼Œçå“æ¢å¾©æœªæŠ½å‡º)")) return;
      // é€™è£¡ç‚ºäº†ç°¡å–®ï¼Œå»ºè­°ç›´æ¥æŒ‰ã€Œåˆå§‹åŒ–è³‡æ–™ã€æŒ‰éˆ•å³å¯ã€‚
      // ä½†å¦‚æœè¦å–®ç´”æ¸…ç©ºï¼Œé‚è¼¯è¼ƒè¤‡é›œ(éœ€å›æ»¾ç‹€æ…‹)ï¼Œæ­¤è™•å»ºè­°å¼•å°ä½¿ç”¨è€…ç”¨åˆå§‹åŒ–ã€‚
      alert("è«‹ä½¿ç”¨ã€Œåˆå§‹åŒ–è³‡æ–™ã€æŒ‰éˆ•ä¾†å®Œå…¨é‡ç½®æ•´å€‹æ´»å‹•ã€‚");
  });

  // --- åŠŸèƒ½ 4: ç›£è½è³‡æ–™åº«è®ŠåŒ– (Read & Real-time Update) ---
  
  // ç›£è½å¾—çåå–®
  const qWinners = query(collection(db, COLL_WINNERS), orderBy("timestamp", "desc"));
  onSnapshot(qWinners, (snapshot) => {
      const listDiv = document.getElementById('winner-list');
      listDiv.innerHTML = "";
      document.getElementById('winner-count').innerText = snapshot.size;

      snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement('div');
          div.className = 'item-row';
          div.innerHTML = `
              <span><b>${data.empName}</b> - ${data.prizeName}</span>
              <span class="delete-btn" id="del-${docSnap.id}">åˆªé™¤</span>
          `;
          listDiv.appendChild(div);

          // ç¶å®šå€‹åˆ¥åˆªé™¤åŠŸèƒ½ (Delete)
          document.getElementById(`del-${docSnap.id}`).addEventListener('click', async () => {
              if(confirm(`ç¢ºå®šåˆªé™¤ ${data.empName} çš„ä¸­çç´€éŒ„ï¼Ÿ(æ³¨æ„ï¼šéœ€æ‰‹å‹•é‡ç½®è©²å“¡å·¥/çå“ç‹€æ…‹æˆ–ç›´æ¥é‡ç½®å…¨éƒ¨)`)) {
                  await deleteDoc(doc(db, COLL_WINNERS, docSnap.id));
              }
          });
      });
  });

  // ç›£è½å‰©é¤˜çå“
  const qPrizes = query(collection(db, COLL_PRIZES));
  onSnapshot(qPrizes, (snapshot) => {
      const listDiv = document.getElementById('prize-list');
      listDiv.innerHTML = "";
      
      const remaining = snapshot.docs.filter(d => !d.data().taken);
      document.getElementById('prize-count').innerText = remaining.length;

      // ç°¡å–®é¡¯ç¤ºå‰ 20 å€‹å‰©é¤˜çå“é¿å…æ´—ç‰ˆ
      remaining.slice(0, 20).forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement('div');
          div.className = 'item-row';
          div.innerText = data.name;
          listDiv.appendChild(div);
      });
      if(remaining.length > 20) {
          const div = document.createElement('div');
          div.style.padding = "10px";
          div.style.color = "#777";
          div.innerText = `...é‚„æœ‰ ${remaining.length - 20} å€‹çå“`;
          listDiv.appendChild(div);
      }
  });

</script>

</body>
</html>